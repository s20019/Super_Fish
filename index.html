<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スーパーフィッシュ</title>
    <script src="src/phaser.js"></script>
</head>
<body>

<script type="text/javascript">

    const WIDTH = 1300;
    const HEIGHT = 600;

    const config = {
        type: Phaser.AUTO,
        width: WIDTH,
        height: HEIGHT,
        physics: {
            default: 'arcade',
            arcade: {
                // 重力を０にしている
                gravity: false,
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update,
            restart: restart
        }
    };

    let player;
    let platforms;

    let heart;
    let heart1;
    let heart2;
    let heart3;

    let fishGroup;
    let iwashi;
    let ami;
    let hirame;
    let buri;
    let ebi;

    let score = 0;
    let scoreText;

    let lifeCount = 3;
    let life = 3;

    let gameOver = false;
    let gameOverText;
    let spaceText;

    const game = new Phaser.Game(config);

    function preload() {
        this.load.image('sea', 'assets/sea.png');
        this.load.image('ebi', 'assets/ebi.png');
        this.load.image('ami', 'assets/ami.png');
        this.load.image('buri', 'assets/buri.png');
        this.load.image('heart', 'assets/heart.png');
        this.load.image('iwashi', 'assets/iwashi.png');
        this.load.image('hirame', 'assets/hirame.png');
        this.load.image('kawahagi', 'assets/kawahagi.png');
        this.load.image('kumanomi', 'assets/kumanomi.png');
    }

    function create() {
        this.add.image(600, 300, 'sea');

        heart = this.physics.add.staticGroup();
        heart1 = heart.create(1200, 570, 'heart').setScale(1 / 8);
        heart2 = heart.create(1150, 570, 'heart').setScale(1 / 8);
        heart3 = heart.create(1100, 570, 'heart').setScale(1 / 8);

        // 網
        ami = this.physics.add.staticGroup();
        ami.create(80, 300, 'ami').setScale(2 / 3).refreshBody();

        // 魚たちを１つにまとめるためのグループ
        fishGroup = this.physics.add.group();

        // イワシ
        iwashi = fishGroup.create(WIDTH, 300, 'iwashi');
        iwashi.setVelocityX(-150);
        iwashi.scaleX = iwashi.scaleX / 8;
        iwashi.scaleY = iwashi.scaleY / 8;

        // ヒラメ
        hirame = fishGroup.create(WIDTH, 100, 'hirame');
        hirame.setVelocityX(-300);
        hirame.scaleX = hirame.scaleX / 5;
        hirame.scaleY = hirame.scaleY / 5;

        // エビ
        ebi = fishGroup.create(WIDTH, 200, 'ebi');
        ebi.setVelocityX(-170);
        ebi.scaleX = ebi.scaleX / 20;
        ebi.scaleY = ebi.scaleY / 20;

        // プレイヤー
        player = this.physics.add.sprite(400, 300, 'kumanomi');

        // プレイヤーが画面外にはみ出ないための処理
        player.setCollideWorldBounds(true);

        // プレイヤーのサイズを縮めている
        player.scaleX = player.scaleX / 6;
        player.scaleY = player.scaleY / 5;

        // スコア
        scoreText = this.add.text(15, 550, 'スコア： 0', { fontSize: '32px', fill: '#fff' });

        this.physics.add.overlap(player, fishGroup, eatFish, null, this);
        this.physics.add.overlap(fishGroup, ami, catchFish, null, this);
    }

    function update() {
        let cursors = this.input.keyboard.createCursorKeys();

        if (gameOver) {
            if (cursors.space.isDown) {
                restart();

                this.physics.resume();
            }
            return;
        }

        // 「 ↑ 」が押されているとき
        if (cursors.up.isDown) {
            player.setVelocityY(-300);
            player.anims.play('up', true);
        }
        // 「 ↓ 」が押されているとき
        else if (cursors.down.isDown) {
            player.setVelocityY(300);
            player.anims.play('down', true);
        }
        // 入力が無い時には停止する処理
        else {
            player.setVelocityY(0);
        }

        // 「 ← 」が押されているとき
        if (cursors.left.isDown) {
            player.setVelocityX(-300);
            player.anims.play('left', true);
        }
        // 「 → 」が押されているとき
        else if (cursors.right.isDown) {
            player.setVelocityX(300);
            player.anims.play('right', true);
        }
        else {
            player.setVelocityX(0);
        }
    }

    function restart() {
        // ゲームオーバーフラグをもとに戻す
        gameOver = false

        // テキストを非表示
        gameOverText.setText('');
        spaceText.setText('');

        // スコアをリセット
        score = 0;
        scoreText.setText('スコア： ' + score).setOrigin(0);

        // プレイヤーを元の位置に戻す
        player.enableBody(true, 400, 300, true, true);

        // 魚たちを元の位置に戻す
        fishGroup.children.iterate(function (fish) {
            fish.enableBody(true, WIDTH, fish.y, true, true);
        });

        iwashi.setVelocityX(-150);
        ebi.setVelocityX(-170);
        hirame.setVelocityX(-300);

        // ライフを再表示
        heart1.enableBody(true, heart1.x, heart1.y, true, true);
        heart2.enableBody(true, heart2.x, heart2.y, true, true);
        heart3.enableBody(true, heart3.x, heart3.y, true, true);
    }

    // 魚を食べた時の処理
    function eatFish (player, fish) {
        // プレイヤーが他の魚よりも大きい場合は食べれる
        if (player.scale >= fish.scale) {
            // 食べると体が大きくなる
            player.scaleX = player.scaleX * 1.08;
            player.scaleY = player.scaleY * 1.08;

            fish.disableBody(true, true);

            score += 10;
            scoreText.setText('スコア： ' + score);
        }
        // プレイヤーの方が小さい場合は衝突する
        else {
            this.physics.add.collider(player, fish);
        }
    }

    // 魚が網に捕まった時の処理
    function catchFish (fish) {
        fish.disableBody(true, true);

        // ライフ = ３
        if (lifeCount === 3) {
            heart3.disableBody(true, true);
            lifeCount -= 1;
        }
        // ライフ = ２
        else if (lifeCount === 2) {
            heart2.disableBody(true, true);
            lifeCount -= 1;
        }
        // ライフ = １
        else if (lifeCount === 1) {
            // 物理法則を一時停止
            this.physics.pause();

            heart1.disableBody(true, true);
            lifeCount = 3;

            // ３つのテキストを、ライフが０になったタイミングで表示する
            gameOverText = this.add.text(550, 250, 'GAME OVER', { fontSize: 50, fill: '#f23' })
            spaceText = this.add.text(610, 380, 'Space で再開', {fontSize: 25, fill: '#fff'});
            scoreText.setOrigin(-3.5, 7);

            // ライフが０になるとゲームオーバーフラグが立つ
            gameOver = true;
        }
    }

</script>

</body>
</html>